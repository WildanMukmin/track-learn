<?php

namespace App\Http\Controllers\Student;

use App\Http\Controllers\Controller;
use App\Models\Course;
use App\Models\Enrollment;
use App\Models\Material;
use App\Models\MaterialProgress;
use App\Models\Quiz;
use App\Models\QuizAttempt;
use Illuminate\Support\Facades\Auth;

class CertificateController extends Controller
{
    public function show($courseId)
    {
        $course = Course::findOrFail($courseId);

        // Ambil enrollment
        $enrollment = Enrollment::where('course_id', $courseId)
            ->where('student_id', Auth::id())
            ->firstOrFail();

        // Total materi
        $totalMaterials = Material::where('course_id', $courseId)->count();

        // Materi selesai
        $completedMaterials = MaterialProgress::where('user_id', Auth::id())
            ->whereIn('material_id', Material::where('course_id', $courseId)->pluck('id'))
            ->where('is_completed', true)
            ->count();

        // Cek apakah semua materi selesai
        $materialDone = $completedMaterials == $totalMaterials;

        // --- CEK KUIS ---
        $totalQuizzes = Quiz::where('course_id', $courseId)->count();

        $passedQuizzes = QuizAttempt::where('enrollment_id', $enrollment->id)
            ->where('is_passed', true)
            ->count();

        // Harus semua kuis lulus
        $quizDone = $passedQuizzes == $totalQuizzes;

        // Jika belum lengkap â†’ blokir
        if (!$materialDone || !$quizDone) {
            return redirect()
                ->route('student.courses.show', $courseId)
                ->with('error', 'Selesaikan semua materi dan kuis untuk mendapatkan sertifikat.');
        }

        return view('student.courses.certificate', compact(
            'course',
            'enrollment'
        ));
    }
}
